-- Copyright (c) 2022 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.
-- SPDX-License-Identifier: Apache-2.0

-- TODO: this should all be moved into the "Contingent claims" library. There is nothing specific to the marketplace here.
{-# LANGUAGE ApplicativeDo #-}
{-# LANGUAGE UndecidableInstances #-} --needed to derive cofree Show,Eq

module Test.Util where

import ContingentClaims.Claim hiding (C, F)
import ContingentClaims.Observation qualified as O
import ContingentClaims.Financial
import DA.Assert ((===))
import DA.Date
import Daml.Script
import Prelude hiding (enumerate, length, or, and, (<=))
import ContingentClaims.Util (hasImpliedAcquisitionTime, impliedAcquisitionTime, expiry, payoffs)

type C = Claim Date Decimal Text

utils = script do
  let call : O.Observation Date Decimal Text = O.observe "VOD.L" - O.pure 103.4
      t = date 2021 Jul 30
      multiplier : O.Observation Date Decimal Text = O.pure 50_000.0

  expiry (european t (Scale call $ one "USD")) === Some t
  payoffs (european t (Scale call $ one "USD")) === [(call, "USD")]

  expiry (forward t multiplier (one "USD")) === Some t
  payoffs (forward t multiplier (one "USD")) === [(multiplier, "USD")]

-- | Test `impliedAcquisitionTime` and `hasImpliedAcquisitionTime`
testAcquisitionTime = script do

  let [a,b] = ["a","b"]
      today = date 1970 Jan 1
      tomorrow = succ today
      o1 = O.observe a
      o2 = O.observe b

  impliedAcquisitionTime (zero : C) === None
  impliedAcquisitionTime (one a : C) === None

  let c1 = when (at today) $ one a
      c2 = anytime (at tomorrow) $ one b
      c3 : C = when (o1 <= o2) $ one a
      c4 : C = anytime (o1 <= o2) (one a)

  impliedAcquisitionTime c1 === Some today
  impliedAcquisitionTime c2 === Some tomorrow
  impliedAcquisitionTime c3 === None
  impliedAcquisitionTime c4 === None
  impliedAcquisitionTime (and c1 c2) === Some today
  impliedAcquisitionTime (mconcat [c1, c2, c3]) === None

  let c5 : C = scale o1 $ one a
      c6 : C = cond (o1 <= o2) (one a) (one b)
      c7 : C = or (one a) (one b)
      c8 : C = until (o1 <= o2) $ one a

  impliedAcquisitionTime c5 === None
  impliedAcquisitionTime c6 === None
  impliedAcquisitionTime c7 === None
  impliedAcquisitionTime c8 === None

  hasImpliedAcquisitionTime c1 === True
  hasImpliedAcquisitionTime c3 === False

  






      





